---
id: "backend-stack"
priority: 850
scope: ["agent"]
when:
  paths: ["backend/**", "api/**", "integrations/**", "services/**", "models/**"]
  languages: ["python"]
---

# ğŸ Flask 3.1 API â€“ Ohmni Backend Canon

* **Runtime**  Python 3.11   (gunicorn 23.0 `-k sync`, app factory `app_minimal:create_app`)
* **Key libs**  Flask 3.1.1 Â· SQLAlchemy 2.0.41 (+ Flask-SQLAlchemy) Â· Alembic via Flask-Migrate  
  * AI clients  `openai 1.84` Â· `anthropic 0.52` Â· `google-generativeai 0.8.5`  
  * Vector search  `azure-search-documents 11.5.2`
* **Datastores**  PostgreSQL, Redis, Azure Cognitive Search (`construction-knowledge`), local `uploads/`
* **Layout (trimmed)**
backend/api/ backend/services/ backend/utils/
integrations/ models/ migrations/ app_minimal.py

markdown
Copy
Edit
* **Refactor Directives**  
1. Centralise AI client â†’ `backend/ai_clients.py`.  
2. Shared vision prompts â†’ `backend/prompts/shared.py`.  
3. File-ext checks â†’ `backend/utils/file_utils.py`.  
4. One Redis init â†’ `extensions/redis.py`.  
5. Single `@skip_options` decorator.  
6. Anthropic/OpenAI wrappers â†’ `backend/ai_providers/`.  
7. Upload-task logic â†’ `backend/services/upload_service.py`.  
8. Chat-title logic â†’ `backend/services/chat_title.py`.
* **Guard-rails**  
* Never touch `migrations/*`, `requirements*.txt`, `pyproject.toml` without explicit bump.  
* Every model change ships with `alembic revision --autogenerate`.  
* Ban stray `print()` / un-parameterised SQL.
* **Tests**  `pytest -q`